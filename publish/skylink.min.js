/*! skylinkjs - v0.5.7 - 2015-02-22 */
function DataChannel(channel,listener){"use strict";listener=listener||function(){};var com=this;if(com.id=channel.label||fn.generateUID(),com.type="message",com.sourceType="local",com.RTCDataChannel=null,com.onconnect=function(){},com.ondisconnect=function(){},com.onerror=function(){},com._handler=function(event,data){DataChannelHandler(com,event,data,listener)},com.bind=function(bindChannel){var onOpenFn=function(){com.handler("datachannel:connect",{})};"open"!==bindChannel.readyState?bindChannel.onopen=onOpenFn:onOpenFn(),bindChannel.onerror=function(error){com.handler("datachannel:error",{error:error})},bindChannel.onclose=function(){com.handler("datachannel:disconnect",{})},bindChannel.onmessage=function(event){com.handler("datachannel:message",{data:event.data})},com.RTCDataChannel=bindChannel,fn.runSync(function(){com.handler("datachannel:start",{})})},com.send=function(data){var sendingData=data;"object"==typeof data&&(sendingData=JSON.stringify(data)),fn.isSafe(function(){com.RTCDataChannel.send(sendingData)})},fn.isEmpty(channel))throw new Error("Provided parameter channel is invalid.");com.bind(channel)}function Peer(stream,config,listener){"use strict";listener=listener||function(){};var com=this;if(com.id=config.id||fn.generateUID(),com.type="main"===config.id?"user":"stream",com._sdpType=config.sdpType||"answer",com._localDescription=null,com._remoteDescription=null,com._dataChannels={},com._dataConnection="user"===com.type?"boolean"==typeof config.dataChannel?config.dataChannel:!0:!1,com._trickleIce="boolean"==typeof config.trickleIce?config.trickleIce:!0,com._healthTimer=null,com._stream=null,com._streamingConfig=null,com._sdpConfig=null,com._RTCPeerConnection=null,com._weight=parseInt(fn.generateUID(),10),com._handler=function(event,data){PeerHandler(com,event,data,listener)},com.reconnect=function(stream){var hasStream=!!stream;stream=stream||fn.isSafe(function(){return com.RTCPeerConnection.getLocalStreams()[0]}),com.RTCPeerConnection.close(),com.RTCPeerConnection=null;var peer=new window.RTCPeerConnection(com.ICEConfig,com.config);(fn.isEmpty(stream)?!1:stream instanceof Stream)&&(peer.addStream(stream.MediaStream),hasStream&&com._handler("peer:stream",{stream:stream}),com._handler("peer:reconnect",{})),com.bind(peer)},com._disconnect=function(){"closed"!==com.RTCPeerConnection.newSignalingState&&com.RTCPeerConnection.close(),com._handler("peer:disconnect",{})},com._bind=function(bind){bind.ondatachannel=function(event){var eventChannel=event.channel||event,channel=new DataChannel(eventChannel,function(event,data){com._handler(event,data),"datachannel:start"===event&&com._handler("peer:datachannel",{channel:channel,sourceType:"remote"})})},bind.onaddstream=function(event){var eventStream=event.stream||event,stream=new Stream(eventStream,config.streamingConfig,function(event,data){com._handler(event,data),"stream:start"===event&&com._handler("peer:stream",{sourceType:"remote",stream:stream})})},bind.onremovestream=function(){},bind.onicecandidate=function(event){var eventCandidate=event.candidate||event;return fn.isEmpty(eventCandidate.candidate)?void com._handler("candidate:gathered",{candidate:eventCandidate}):void com._handler("peer:icecandidate",{sourceType:"local",candidate:eventCandidate})},PeerHelper.ICE.state(bind),bind.oniceconnectionnewstatechange=function(){"connected"===com.RTCPeerConnection.newIceConnectionState&&(fn.isEmpty(com.healthTimer)||(log.debug("Peer",com.id,"Stopping health timer as connection is established."),clearInterval(com.healthTimer))),com._handler("peer:iceconnectionstate",{state:com.RTCPeerConnection.newIceConnectionState})},bind.onsignalingstatechange=function(){com._handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})},bind.onicegatheringstatechange=function(){com._handler("peer:icegatheringstate",{state:com.RTCPeerConnection.iceGatheringState})},bind.onnegotiationneeded=function(){com._handler("peer:ready",{weight:com._weight,sdpType:com._sdpType,streamingConfig:com._streamingConfig})},com.RTCPeerConnection=bind,fn.runSync(function(){com._handler("peer:ready",{weight:com.weight,SDPType:com.SDPType,streamingConfig:com.streamingConfig})})},com._initiate=function(){if(com._dataConnection)var eventChannel=com.RTCPeerConnection.createDataChannel("main"),channel=new DataChannel(eventChannel,function(event,data){com._handler(event,data),com._handler("peer:datachannel",{sourceType:"local",channel:channel})});com.RTCPeerConnection.createOffer(function(offer){offer.sdp=SDP.configure(offer.sdp,com.sdpConfig),com.localDescription=offer,com._handler("peer:offer",{offer:offer})},function(error){throw error},com.sdpConstraints)},com.createAnswer=function(){com.RTCPeerConnection.createAnswer(function(answer){answer.sdp=SDP.configure(answer.sdp,com.sdpConfig),com.localDescription=answer,com._handler("peer:answer",{answer:answer}),com.setLocalDescription()},function(error){throw error},com.sdpConstraints)},com.setLocalDescription=function(){var localDescription=com.localDescription;com.RTCPeerConnection.setLocalDescription(localDescription,function(){com._handler("peer:localdescription",{localDescription:localDescription.sdp,type:localDescription.type}),"answer"===localDescription.type?(com.RTCPeerConnection.newSignalingState="have-local-answer",com._handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.setRemoteDescription()},function(error){throw error})},com.setRemoteDescription=function(){var remoteDescription=com.remoteDescription;com.RTCPeerConnection.setRemoteDescription(remoteDescription,function(){com._handler("peer:remotedescription",{remoteDescription:remoteDescription.sdp,type:remoteDescription.type}),"answer"===remoteDescription.type?(com.RTCPeerConnection.newSignalingState="have-remote-answer",com._handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.createAnswer(),ICE.popCandidate(com.RTCPeerConnection,com.handler)},function(error){throw error})},com.onready=function(){},com.onconnect=function(){},com.oniceconnectionstatechange=function(){},com.onicegatheringstatechange=function(){},com.onaddstream=function(){},com.onsignalingstatechange=function(){},com.onreconnect=function(){},com.ondisconnect=function(){},!window.RTCPeerConnection)throw new Error("Required dependency adapterjs not found");com._streamingConfig=config.streamingConfig||{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}},com._sdpConfig={stereo:!!config.streamingConfig.audio.stereo,bandwidth:StreamParser.parseBandwidthConfig(config.bandwidth)};var peerConfig={iceServers:config.iceServers},peer=PeerHelper.create(peerConfig);com._bind(peer),fn.runSync(function(){(fn.isEmpty(stream)?!1:stream instanceof Stream)?(peer.addStream(stream.MediaStream),com._handler("peer:stream",{sourceType:"local",stream:stream})):com._handler("peer:ready",{weight:com._weight,sdpType:com._sdpType,streamingConfig:com._streamingConfig})})}function Room(name,listener){"use strict";listener=listener||function(){};var com=this;com.name=name,com.id=null,com.token=null,com.key=null,com.startDateTime=null,com.duration=null,com.apiPath=null,com.owner=null,com.credentials=globals.credentials,com.self=null,com.users={},com.components={},com.socket=null,com.iceServers=[],com.connected=!1,com.locked=!1,com.oninit=function(){},com.onready=function(){},com.onjoin=function(){},com.onuserjoin=function(){},com.onkick=function(){},com.onwarn=function(){},com.onlock=function(){},com.onunlock=function(){},com.onleave=function(){},com.handler=function(event,data){RoomHandler(com,event,data,listener)},com.init=function(){var path="/api/"+globals.apiKey+"/"+com.name;null!==com.credentials&&(path+=com.credentials.startDateTime+"/"+com.credentials.duration+"?&cred="+com.credentials.hash),globals.region&&(path+=(path.indexOf("?&")>-1?"&":"?&")+"rg="+globals.region),Request.load(path,function(status,content){com.apiPath=path,com.key=content.cid,com.id=content.room_key,com.token=content.roomCred,com.startDateTime=content.start,com.duration=content.len,com.owner=content.apiOwner;var userConfig={id:null,username:content.username,token:content.userCred,timeStamp:content.timeStamp,data:null};com.self=new Self(userConfig,com.routeEvent);var socketConfig={server:content.ipSigserver,httpPortList:content.httpPortList,httpsPortList:content.httpsPortList};com.socket=new Socket(socketConfig,com.routeEvent),com.respond("room:ready")},function(status,error){com.respond("room:error",{error:error})},function(){com.respond("room:init")})},com.join=function(stream,config){if(com.connected)throw new Error('You are already connected to this "'+com.name+'" room');config=config||{},com.self.bandwidth=StreamParser.parseBandwidthConfig(config.bandwidth),com.self.data=config.userData,("object"==typeof stream?stream instanceof Stream:!1)&&com.self.addStreamConnection(stream,"main"),com.socket.connect()},com.leave=function(){com.socket.disconnect()},com.lock=function(){var message={type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!0};com.socket.send(message),com.respond("room:lock",{selfId:com.self.id})},com.unlock=function(){var message={type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!1};com.socket.send(message),com.respond("room:unlock",{userId:com.self.id})},com.sendStream=function(stream){var key,peerId=fn.generateUID();com.self.addStreamConnection(stream,peerId);for(key in com.users)if(com.users.hasOwnProperty(key)){var message={type:"enter",mid:com.self.id,rid:com.id,prid:peerId,stream:com.self.getStreamingInfo("main")};com.users[key].routeMessage("message:enter",message)}},com.init()}function Self(config,listener){var com=this;com.id=null,com.data=config.data,com.username=config.username,com.timeStamp=config.timeStamp,com.token=config.token,com.streamConnections={},com.agent={name:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType},com.bandwidth={},com.routeEvent=function(event,data){var params=event.split(":");data=data||{},data.roomName=com.name,fn.applyHandler(SelfEventReceivedHandler,params,[com,data,listener]),listener(event,data),log.debug("Self: Received event = ",event,data)},com.routeMessage=function(message){var fn=SelfEventMessageHandler[message.type];"function"==typeof fn&&fn(com,message,listener),log.debug("Self: Received message = ",event,message)},com.respond=function(event,data){var params=event.split(":");data=data||{},data.name=com.name,fn.applyHandler(SelfEventResponseHandler,params,[com,data,listener]),listener(event,data),log.debug("Self: Responding with event = ",event,data)},com.onready=function(){},com.onconnect=function(){},com.onupdate=function(){},com.onaddstreamconnection=function(){},com.onremovestreamconnection=function(){},com.ondisconnect=function(){},com.update=function(data){com.data=data,com.respond("self:update",{userData:com.data})},com.addStreamConnection=function(stream,peerId){stream.sourceType="local",stream.routeEventToParent=com.routeEvent,com.streamConnections[peerId]=stream,com.respond("self:addstreamconnection",{peerId:peerId,stream:stream})},com.findStreamConnectionId=function(streamId){var key;for(key in com.streamConnections)if(com.streamConnections.hasOwnProperty(key)&&com.streamConnections[key].id===streamId)return key},com.removeStreamConnection=function(peerId){if(fn.isEmpty(peerId)||"main"===peerId){var key;for(key in com.streamConnections)com.streamConnections.hasOwnProperty(key)&&com.streamConnections[key].stop()}else{var stream=com.streamConnections[peerId];("object"==typeof stream?stream instanceof Stream:!1)?stream.stop():log.error("Unable to remove stream connection as there is not existing stream connection to the peer connection",peerId)}},com.getInfo=function(peerId){var data={},getStreamSettingsFn=function(stream){return stream=stream||{},stream.config||{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};if(data.userData=com.data,data.agent=com.agent,data.bandwidth=com.bandwidth,fn.isEmpty(peerId)){data.streams={};var key;for(key in com.streamConnections)com.streamConnections.hasOwnProperty(key)&&(data.streams[key]=getStreamSettingsFn(com.streamConnections[key]))}else data.stream=getStreamSettingsFn(com.streamConnections[peerId]);return data},com.respond("self:ready",config)}function Socket(config,listener){"use strict";listener=listener||function(){};var com=this;if(com.server=config.server,com.protocol=globals.enforceSSL?"https:":window.location.protocol,com.port=null,com.timeout=globals.socketTimeout||0,com.messageInterval=1e3,com.messageQueue=[],com.ports={"https:":config.httpsPortList,"http:":config.httpPortList},com.config={},com.type=config.type||"WebSocket",com.Socket=null,com.onready=function(){},com.onconnect=function(){},com.ondisconnect=function(){},com.onconnecterror=function(){},com.onreconnect=function(){},com.onerror=function(){},com._handler=function(event,data){SocketHandler(com,event,data,listener)},com.connect=function(){com.port=com.ports[window.location.protocol][0],com.Socket="XHRPolling"===com.type?new com.XHRPolling:new com.WebSocket},com.disconnect=function(){com.Socket.disconnect()},com.send=function(data){com.Socket.send(JSON.stringify(data)),com.respond("socket:message",{message:data,sourceType:"local"})},com.bindOnConnect=function(){com.respond("socket:connect"),com.Socket.removeAllListeners(),com.Socket.on("disconnect",function(){com.respond("socket:disconnect"),"function"==typeof com.onerror&&com.ondisconnect()}),com.Socket.on("message",function(result){var data=JSON.parse(result);if("group"===data.type){log.info("Received a group message. Breaking down messages into individual messages",data);var i;for(i=0;i<data.list.length;i++){var message=data.list[i];com.respond("socket:message",{message:message,sourceType:"remote"})}}else com.respond("socket:message",{message:data,sourceType:"remote"})}),com.Socket.on("error",function(error){com.respond("socket:error",{error:error}),"function"==typeof com.onerror&&com.onerror(error)}),"function"==typeof com.onconnect&&com.onconnect()},com.bindOnConnectError=function(error){com.respond("socket:connecterror",{error:error});var i,ports=com.ports[window.location.protocol];for(i=0;i<ports.length;i+=1)if(ports[i]===com.port){i+1<ports.length?(com.port=ports[i+1],com.reconnect()):"WebSocket"===com.type&&(com.type="XHRLongPolling",com.port=ports[0],com.reconnect());break}"function"==typeof com.onconnecterror&&com.onconnecterror(error)},com.reconnect=function(){switch(com.Socket.removeAllListeners(),com.type){case"WebSocket":com.Socket=com.WebSocket();break;default:com.Socket=com.XHRPolling()}com.respond("socket:reconnect")},com.WebSocket=function(){var options={forceNew:!0,reconnection:!1,transports:["websocket"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return com.config=options,socket.on("connect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket},com.XHRPolling=function(){var ports=com.ports[window.location.protocol],options={forceNew:!0,reconnection:com.port===ports[ports.length-1],transports:["xhr-polling","jsonp-polling","polling"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return com.config=options,socket.on("connect",com.bindOnConnect),socket.on("reconnect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket.on("reconnect_failed",com.bindOnConnectError),socket},!window.io)throw new Error("Required dependency socket.io not found");fn.runSync(function(){com.respond("socket:ready",config)})}function Stream(stream,config,listener){"use strict";listener=listener||function(){};var com=this;if(com.id=null,com.label="",com._constraints=null,com.config=config,com.sourceType="local",com._MediaStream=null,com._parentHandler=function(){},com._handler=function(event,data){StreamHandler(com,event,data,listener),"function"==typeof com._parentHandler&&com._parentHandler(event,data)},com._bind=function(bind){com.id=fn.generateUID(),StreamPolyfill.checkEnded(bind),bind.onended=function(){com._handler("stream:stop",{})},com.label=bind.label||"Stream "+com.id,com._bindTracks(bind.getAudioTracks(),bind),com._bindTracks(bind.getVideoTracks(),bind),com._MediaStream=bind,com._handler("stream:start",{})},com._bindTracks=function(bindTracks,bind){var i,onended=function(track){return function(){com._handler("stream:track:stop",{track:track})}},onmute=function(track){return function(){com._handler("stream:track:mute",{track:track})}},onunmute=function(track){return function(){com._handler("stream:track:unmute",{track:track})}};for(i=0;i<bindTracks.length;i+=1){var track=bindTracks[i],trackData={id:track.id||fn.generateUID(),kind:track.kind,label:track.label,facing:track.facing};track.onended=onended(trackData),track.onmute=onmute(trackData),track.onunmute=onunmute(trackData),StreamPolyfill.track.checkEnded(track,bind),StreamPolyfill.track.checkMute(track,bind),StreamPolyfill.track.checkUnmute(track,bind);var isEnabled=!0;isEnabled="audio"===track.kind?"object"==typeof com.config.audio?!com.config.audio.mute:!!com.config.audio:"object"==typeof com.config.video?!com.config.video.mute:!!com.config.video,track.enabled=isEnabled,window.track=track,com._handler("stream:track:start",{track:track})}},com.attachElement=function(element){StreamPolyfill.attachMediaStream(element,com._MediaStream)},com.stop=function(){StreamPolyfill.stop(com._MediaStream)},com.stopAudio=function(){if(com.config.audio===!1)return void log.warn("There is no available audio tracks to stop");var i,tracks=com._MediaStream.getAudioTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.stop(track)}},com.stopVideo=function(){if(com.config.video===!1)return void log.warn("There is no available video tracks to stop");var i,tracks=com._MediaStream.getVideoTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.stop(track)}},com.muteAudio=function(){if(com.config.audio===!1)return void log.warn("There is no available audio tracks to mute");var i,tracks=com._MediaStream.getAudioTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.mute(track,com._MediaStream.id)}},com.muteVideo=function(){if(com.config.video===!1)return void log.warn("There is no available video tracks to mute");var i,tracks=com._MediaStream.getVideoTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.mute(track,com._MediaStream.id)}},com.unmuteAudio=function(){if(com.config.audio===!1)return void log.warn("There is no available audio tracks to unmute");var i,tracks=com._MediaStream.getAudioTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.unmute(track,com._MediaStream.id)}},com.unmuteVideo=function(){if(com.config.video===!1)return void log.warn("There is no available video tracks to unmute");var i,tracks=com._MediaStream.getVideoTracks();for(i=0;i<tracks.length;i+=1){var track=tracks[i];StreamPolyfill.track.unmute(track,com._MediaStream.id)}},com.onstart=function(){},com.onerror=function(){},com.ontrackstart=function(){},com.ontrackstop=function(){},com.ontrackmute=function(){},com.ontrackunmute=function(){},com.onstop=function(){},!window.attachMediaStream)throw new Error("Required dependency adapterjs not found");if(fn.isEmpty(stream)){var audioSettings=StreamParser.parseAudioConfig(config.audio),videoSettings=StreamParser.parseVideoConfig(config.video);com._constraints={audio:audioSettings.userMedia,video:videoSettings.userMedia},com.config={audio:audioSettings.settings,video:audioSettings.settings},window.getUserMedia(com._constraints,com._bind,function(error){com._handler("stream:error",{error:error,sourceType:com.sourceType})})}else fn.runSync(function(){com.config={audio:fn.isSafe(function(){return stream.getAudioTracks().length>0}),video:fn.isSafe(function(){return stream.getVideoTracks().length>0})},com._bind(stream)})}function User(config,listener){"use strict";listener=listener||function(){};var com=this;com.id=config.id,com.type="user",com.data=config.data||{},com.agent=config.agent||{},com.bandwidth=config.bandwidth||{},com.peers={},com._handler=function(event,data){UserHandler(com,event,data,listener)},com.addConnection=function(data,stream){var peerConfig={id:data.prid,iceServers:data.iceServers,sdpConfig:{bandwidth:data.bandwidth,stereo:fn.isSafe(function(){return!!data.settings.audio.stereo}),SDPType:data.SDPType},streamingConfig:data.settings};com.streamingConfigs[data.stream.prid]=data.settings;var peer=new Peer(peerConfig,com.routeEvent);peer.connect(stream),com.peers[peer.id]=peer,com._handler("user:addconnection",{peer:peer,peerId:data.prid,config:peerConfig})},com.removeConnection=function(peerId){var peer=com.peers[peerId];fn.isEmpty(peer)||peer.disconnect(),com._handler("user:removeconnection",{peerId:peerId})},com.disconnect=function(){fn.forEach(com.peers,function(peer){peer.disconnect()})},com.getInfo=function(peerId){var data={},getStreamSettingsFn=function(peer){var stream=peer.stream||{};return stream.config||{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};if(data.userData=com.data,data.agent=com.agent,data.bandwidth=com.bandwidth,fn.isEmpty(peerId)){data.streams={};var key;for(key in com.peers)if(com.peers.hasOwnProperty(key)){var peer=com.peers[key],settings=getStreamSettingsFn(peer);settings.bandwidth=peer.bandwidth||{},data.streams[peer.id]=settings}}else{var onepeer=com.peers[peerId];if(fn.isEmpty(onepeer))throw new Error('Peer connection for "'+peerId+'" does not exist');data.stream=getStreamSettingsFn(onepeer)}return data},com.onready=function(){},com.onupdate=function(){},com.onconnect=function(){},com.ondisconnect=function(){},com.onaddconnection=function(){},com.onremoveconnection=function(){},com.ondatarequest=function(){},com.ondata=function(){},com.onmessage=function(){},fn.runSync(function(){com._handler("user:ready",config)})}var globals={apiKey:null,region:"us2",defaultRoom:null,roomServer:"//api.temasys.com.sg",enforceSSL:!1,socketTimeout:0,TURNServer:!0,STUNServer:!0,ICETrickle:!0,TURNTransport:"any",dataChannel:!0,audioFallback:!1,credentials:null},fn={isEmpty:function(data){var isUnDefined="undefined"==typeof data||null===data;return"object"!=typeof data||isUnDefined?isUnDefined:data.constructor===Array?0===data.length:0===Object.keys(data).length},isSafe:function(unsafeFn){try{return unsafeFn()}catch(error){return log.warn("Function",error),!1}},runSync:function(){var args=Array.prototype.slice.call(arguments),run=function(fn){setTimeout(fn,1),args.splice(0,1),0!==args.length&&run(args[0])};run(args[0])},constant:function(main,property,value){var obj={};obj[property]={value:value,enumerable:!0},Object.defineProperties(main,obj)},generateUID:function(){return(new Date).getTime().toString()},applyHandler:function(callee,params,args){var i,item=callee;for(i=0;i<params.length;i+=1)fn.isEmpty(item[params[i]])||(item=item[params[i]]);"function"==typeof item&&item.apply(this,args)}},log={};window.console.newDebug="function"!=typeof window.console.debug?window.console.log:window.console.debug,window.console.newTrace="function"!=typeof window.console.trace?window.console.log:window.console.trace;var LogKey="Skylink - ",Debugger={level:2,trace:!1,store:!1,logs:[],console:{log:window.console.log.bind(window.console,LogKey+"%s> %s"),error:window.console.error.bind(window.console,LogKey+"%s> %s"),info:window.console.info.bind(window.console,("safari"===window.webrtcDetectedBrowser?"INFO: ":"")+LogKey+"%s> %s"),warn:window.console.warn.bind(window.console,LogKey+"%s> %s"),debug:window.console.newDebug.bind(window.console,("function"!=typeof window.console.debug?"DEBUG: ":"")+LogKey+"%s> %s")},traceTemplate:{log:"==LOG== "+LogKey+"%s",error:"==ERROR== "+LogKey+"%s",info:"==INFO== "+LogKey+"%s",warn:"==WARN== "+LogKey+"%s",debug:"==DEBUG== "+LogKey+"%s"},applyConsole:function(type){var args=Array.prototype.slice.call(arguments);return args.shift(),this.store&&logs.push(type,args,new Date),this.trace?window.console.newTrace.bind(window.console,this.traceTemplate[type]):this.console[type]},setLevel:function(inputLevel){log.debug=inputLevel>3?this.applyConsole("debug"):function(){},log.log=inputLevel>2?this.applyConsole("log"):function(){},log.info=inputLevel>1?this.applyConsole("info"):function(){},log.warn=inputLevel>0?this.applyConsole("warn"):function(){},log.error=inputLevel>-1?this.applyConsole("error"):function(){},this.level=inputLevel},configure:function(options){options=options||{},Debugger.store=!!options.store,Debugger.trace=!!options.trace,Debugger.setLevel("number"==typeof options.level?options.level:2)}};Debugger.setLevel(4);var Skylink={},rooms=[],Config=function(options){globals.apiKey=options.apiKey};Skylink.init=function(apiKey,name,listener){return rooms[name]=new Room(name,listener),rooms[name]},Skylink.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error"},Skylink.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},Skylink.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},Skylink.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},Skylink.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},Skylink.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},Skylink.TURN_TRANSPORT={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none"},Skylink.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},Skylink.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},Skylink.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},Skylink.SYSTEM_ACTION_REASON={FAST_MESSAGE:"fastmsg",ROOM_LOCKED:"locked",ROOM_FULL:"roomfull",DUPLICATED_LOGIN:"duplicatedLogin",SERVER_ERROR:"serverError",VERIFICATION:"verification",EXPIRED:"expired",ROOM_CLOSED:"roomclose",ROOM_CLOSING:"toclose",OVER_SEAT_LIMIT:"seatquota"},Skylink.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},Skylink.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NOT_ENOUGH_CREDIT:4007,API_NOT_ENOUGH_PREPAID_CREDIT:4008,API_FAILED_FINDING_PREPAID_CREDIT:4009,API_NO_MEETING_RECORD_FOUND:4010,ROOM_LOCKED:5001,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,INVALID_XMLHTTPREQUEST_STATUS:5,SCRIPT_ERROR:6},Skylink.REGIONAL_SERVER={APAC1:"sg",US1:"us2"},Skylink.LOG_LEVEL={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0},Skylink.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},Skylink.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},Skylink.VIDEO_RESOLUTION={QQVGA:{width:160,height:120,aspectRatio:"4:3"},HQVGA:{width:240,height:160,aspectRatio:"3:2"},QVGA:{width:320,height:180,aspectRatio:"4:3"},WQVGA:{width:384,height:240,aspectRatio:"16:10"},HVGA:{width:480,height:320,aspectRatio:"3:2"},VGA:{width:640,height:360,aspectRatio:"4:3"},WVGA:{width:768,height:480,aspectRatio:"16:10"},FWVGA:{width:854,height:480,aspectRatio:"16:9"},SVGA:{width:800,height:600,aspectRatio:"4:3"},DVGA:{width:960,height:640,aspectRatio:"3:2"},WSVGA:{width:1024,height:576,aspectRatio:"16:9"},HD:{width:1280,height:720,aspectRatio:"16:9"},HDPLUS:{width:1600,height:900,aspectRatio:"16:9"},FHD:{width:1920,height:1080,aspectRatio:"16:9"},QHD:{width:2560,height:1440,aspectRatio:"16:9"},WQXGAPLUS:{width:3200,height:1800,aspectRatio:"16:9"},UHD:{width:3840,height:2160,aspectRatio:"16:9"},UHDPLUS:{width:5120,height:2880,aspectRatio:"16:9"},FUHD:{width:7680,height:4320,aspectRatio:"16:9"},QUHD:{width:15360,height:8640,aspectRatio:"16:9"}};var DataProcess={chunkSize:49152,mozChunkSize:16384,chunk:function(blob){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this.chunkSize){for(;blobByteSize-1>endCount;)endCount=startCount+this.chunkSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this.chunkSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},unchunk:function(){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])}},_Event={listeners:{on:{},once:{}},timestamp:{now:Date.now()||function(){return+new Date}},on:function(event,listener){this.listeners.on[event]=this.listeners.on[event]||[],this.listeners.on[event].push(listener)},once:function(event,listener){this.listeners.once[event]=this.listeners.once[event]||[],this.listeners.once[event].push(listener)},off:function(event,listener){return fn.isEmpty(event)?(this.listeners.on={},void(this.listeners.once={})):void("function"==typeof listener?(this.remove(this.listeners.on[event]||{},listener),this.remove(this.listeners.once[event]||{},listener)):(this.listeners.on[event]=[],this.listeners.once[event]=[]))},respond:function(event){var args=Array.prototype.slice.call(arguments);args.shift();var on=this.listeners.on[event]||{},once=this.listeners.once[event]||{};this.trigger(on,args),this.trigger(once,args),this.listeners.once[event]=[]},trigger:function(listeners,args){var i;for(i=0;i<listeners.length;i+=1)try{listeners[i].apply(this,args)}catch(error){throw error}},remove:function(listeners,listener){var i=0;for(i=0;i<listeners.length;i+=1)if(listeners[i]===listener){listeners.splice(i,1);break}},throttle:function(defer,wait){return function(){fn.isEmpty(this.timeStamp.func)&&(this.timeStamp.func=this.timestamp.now-wait);var now=Date.now();now-this.timestamp.func<wait||(func.apply(this,arguments),this.timeStamp.func=now)}}};Skylink.Event=_Event;var EventList=["channelOpen","channelClose","channelMessage","channelError","channelRetry","socketError","readyStateChange","handshakeProgress","candidateGenerationState","peerConnectionState","peerConnectionHealth","iceConnectionState","mediaAccessError","mediaAccessSuccess","mediaAccessRequired","mediaAccessStopped","peerJoined","peerRestart","peerUpdated","peerLeft","presenceChanged","incomingStream","incomingMessage","roomLock","dataChannelState","dataTransferState","systemAction"],Request={server:globals.roomServer||"//api.temasys.this.sg",isXDomainRequest:"IE"===window.webrtcDetectedBrowser&&(9===window.webrtcDetectedVersion||8===window.webrtcDetectedVersion)&&"function"==typeof window.XDomainRequest,protocol:globals.enforceSSL?"https:":window.location.protocol,load:function(path,deferSuccess,deferError,deferLoad){var xhr=null;this.isXDomainRequest?(xhr=new XDomainRequest,xhr.setContentType=function(contentType){xhr.contentType=contentType}):(xhr=new window.XMLHttpRequest,xhr.setContentType=function(contentType){xhr.setRequestHeader("Content-type",contentType)}),xhr.onload=function(){var response=xhr.responseText||xhr.response,status=xhr.status||200;log.info("Request","Received response from API server",response,status);try{response=JSON.parse(response||"{}")}catch(error){throw error}200===status?deferSuccess(status,response):deferError(status,response)},xhr.onerror=function(error){throw error},xhr.onprogress=function(){log.log("Request","Request load in progress"),deferLoad()
},xhr.open("GET",this.protocol+this.server+path,!0),xhr.send()}},SDP={find:function(sdpLines,condition){var i,j;for(i=0;i<sdpLines.length;i+=1)for(j=0;j<condition.length;j+=1)if(sdpLines[i]=sdpLines[i]||"",0===sdpLines[i].indexOf(condition[j]))return[i,sdpLines[i]];return[]},addStereo:function(sdpLines){var opusLineFound=!1,opusPayload=0,rtpmapLine=this.find(sdpLines,["a=rtpmap:"]);if(rtpmapLine.length&&0===rtpmapLine[1].split(" ")[1].indexOf("opus/48000/")&&(opusLineFound=!0,opusPayload=rtpmapLine[1].split(" ")[0].split(":")[1]),opusLineFound){var fmtpLine=this.find(sdpLines,["a=fmtp:"+opusPayload]);fmtpLine.length&&(sdpLines[fmtpLine[0]]=fmtpLine[1]+"; stereo=1")}return sdpLines},setBitrate:function(sdpLines,bandwidth){var maLineFound=this.find(sdpLines,["m=","a="]).length,cLineFound=this.find(sdpLines,["c="]).length;if(maLineFound&&cLineFound){if(bandwidth.audio){var audioLine=this.find(sdpLines,["a=audio","m=audio"]);fn.isEmpty(audioLine)||sdpLines.splice(audioLine[0],1,audioLine[1],"b=AS:"+bandwidth.audio)}if(bandwidth.video){var videoLine=this.find(sdpLines,["a=video","m=video"]);fn.isEmpty(videoLine)||sdpLines.splice(videoLine[0],1,videoLine[1],"b=AS:"+bandwidth.video)}if(bandwidth.data&&this._enableDataChannel){var dataLine=this.find(sdpLines,["a=application","m=application"]);fn.isEmpty(dataLine)||sdpLines.splice(dataLine[0],1,dataLine[1],"b=AS:"+bandwidth.data)}}return sdpLines},setResolution:function(sdpLines){var video=this._streamSettings.video,frameRate=video.frameRate||50,resolution=video.resolution||{},fmtpLine=this.find(sdpLines,["a=fmtp:"]);return fmtpLine.length&&sdpLines.splice(fmtpLine[0],1,fmtpLine[1]+";max-fr="+frameRate+";max-recv-width="+(resolution.width?resolution.width:640)+";max-recv-height="+(resolution.height?resolution.height:480)),sdpLines},removeH264Support:function(sdpLines){var invalidLineIndex=sdpLines.indexOf("a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1");return invalidLineIndex>-1&&(log.debug("Firefox H264 invalid pref found:",invalidLineIndex),sdpLines.splice(invalidLineIndex,1)),sdpLines},configure:function(sdp,config){var sdpLines=sdp.split("\r\n");return sdpLines=this.removeH264Support(sdpLines),config.stereo&&(sdpLines=this.addStereo(sdpLines)),config.bandwidth&&(sdpLines=this.setBitrate(sdpLines,config.bandwidth)),sdpLines.join("\r\n")}},DataChannelEventResponseHandler={start:function(com){"function"==typeof com.onstart&&com.onstart()},connect:function(com){"function"==typeof com.onconnect&&com.onconnect()},error:function(com){"function"==typeof com.onerror&&com.onerror(error)},message:function(){},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()}},DataChannelHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,fn.applyHandler(DataChannelEventResponseHandler,params,[com,data,listener]),listener(event,data)},PeerEventMessageHandler={offer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:offer",{sourceType:"remote",offer:com.remoteDescription}),com.setRemoteDescription()},answer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:answer",{sourceType:"remote",answer:com.remoteDescription}),com.setLocalDescription()},candidate:function(com,data){var candidate=new window.RTCIceCandidate({sdpMLineIndex:data.label,candidate:data.candidate,sdpMid:data.id,label:data.label,id:data.id});ICE.addCandidate(com.RTCPeerConnection,candidate,com.handler),com.handler("peer:icecandidate",{sourceType:"remote",candidate:candidate})},restart:function(){},muteAudioEvent:function(com,data){data.muted?com.stream.muteAudio():com.stream.muteVideo()},muteVideoEvent:function(com,data){data.muted?com.stream.unmuteAudio():com.stream.unmuteVideo()}},PeerEventReceivedHandler={stream:{stop:function(com){"main"!==com.id&&com.disconnect()}}},PeerEventResponseHandler={connect:function(com){"function"==typeof com.onconnect&&com.onconnect(com.id)},reconnect:function(com){"function"==typeof com.onreconnect&&com.onreconnect()},connected:function(com){"function"==typeof com.onconnect&&com.onconnect(com.id)},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()},stream:function(com,data){data.stream.sourceType=data.sourceType,"remote"===data.sourceType&&(com.stream=data.stream),"function"==typeof com.onaddstream&&com.onaddstream(data.stream)},iceconnectionstate:function(com,data){"function"==typeof com.oniceconnectionstatechange&&com.oniceconnectionstatechange(data.state)},icegatheringstate:function(com,data){"function"==typeof com.onicegatheringstatechange&&com.onicegatheringstatechange(data.state)},icecandidate:function(){},signalingstate:function(com,data){"function"==typeof com.onsignalingstatechange&&com.onsignalingstatechange(data.state)},datachannel:function(com,data){data.channel.sourceType=data.sourceType,com.datachannels[data.channel.id]=data.channel,"function"==typeof com.ondatachannel&&com.ondatachannel(data.channel)}},PeerHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?fn.applyHandler(PeerEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("peer:")?(data.id=com.id,fn.applyHandler(PeerEventResponseHandler,params,[com,data,listener])):(data.peerId=com.id,fn.applyHandler(PeerEventReceivedHandler,params,[com,data,listener])),listener(event,data))},PeerHelper={create:function(config,optional){var peerConfig=null,peerOptional={optional:[{DtlsSrtpKeyAgreement:!0}]};null!==config&&"object"==typeof config&&(peerConfig=config,("object"==typeof config.iceServers?config.iceServers instanceof Array:!1)&&(peerConfig.iceServers=this.ICE.configureTURN(peerConfig.iceServers))),null!==config&&"object"==typeof config&&(peerOptional=optional);var peer=new window.RTCPeerConnection(peerConfig,peerOptional);if(("function"!=typeof peer.getConfiguration||"firefox"===window.webrtcDetectedBrowser)&&(peer.getConfiguration=function(){return peerConfig.optional="object"==typeof peerOptional?peerOptional.optional||null:null,peerConfig}),("function"!=typeof peer.getStreamById||"firefox"===window.webrtcDetectedBrowser)&&(peer.getStreamById=function(streamId){var i,j,localStreams=peer.getLocalStreams(),remoteStreams=peer.getRemoteStreams();for(i=0;i<localStreams.length;i+=1)if(streamId===localStreams[i].id)return localStreams[i];for(j=0;j<remoteStreams.length;j+=1)if(streamId===remoteStreams[i].id)return remoteStreams[j];return null}),"boolean"!=typeof peer.canTrickleIceCandidates&&(peer.canTrickleIceCandidates="firefox"===window.webrtcDetectedBrowser?window.webrtcDetectedVersion>27:!0),"chrome"!==window.webrtcDetectedBrowser&&"opera"!==window.webrtcDetectedBrowser)var remoteStreamStatusChangedFn=function(prev){prev===!0&&peer.onremovestream(peer)},remoteStreamChecker=setInterval(function(){"undefined"==typeof peer.hasStream&&(peer.hasStream=peer.getRemoteStreams().length>0),"closed"===peer.signalingState&&clearInterval(remoteStreamChecker);var status=peer.getRemoteStreams().length>0;peer.hasStream!==status&&(remoteStreamStatusChangedFn(!!peer.hasStream,status),peer.hasStream=status)},10);return peer},addStream:function(peer,stream){if("chrome"===window.webrtcDetectedBrowser&&"opera"===window.webrtcDetectedBrowser)peer.addStream(stream);else{if(peer.getLocalStream().length>0)return void log.warn("StreamPolyfill","You cannot add more than 1 stream. Multi-stream sending is not supported in "+window.webrtcDetectedBrowser.toUpperCase()+("plugin"===window.webrtcDetectedType?" (plugin-enabled)":"")+" browser");peer.addStream(stream),"function"==typeof peer.onnegotiationneeded&&peer.onnegotiationneeded(peer)}},removeStream:function(peer,stream){if("chrome"===window.webrtcDetectedBrowser&&"opera"===window.webrtcDetectedBrowser)peer.removeStream(stream);else if(peer.getLocalStream().length>0){var optional,constraints=null;"object"==typeof peer.constraints&&(constraints=peer.constraints,optional=peer.optional);var key,peer2=this.create(constraints,optional),unwantedKeys=["signalingState","iceConnectionState","iceGatheringState","localDescription","remoteDescription","createDataChannel","updateIce","addIceCandidate","addStream","removeStream","getStats","getStreamById","createDataChannel","createDTMFSender","createOffer","createAnswer","setLocalDescription","setRemoteDescription","getSenders","getReceivers","addTrack","removeTrack"];for(key in peer)if(peer.hasOwnProperty(key)&&-1===unwantedKeys.indexof(key))try{peer2[key]=peer[key]}catch(error){log.warn('Not supported to replace "'+key+'" key')}peer2.newiceConnectionState&&this.ICE.state(peer2),"function"==typeof peer2.onnegotiationneeded&&peer2.onnegotiationneeded(peer2),peer=peer2}},ICE:{state:function(peer){var updatedStateList={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"};peer.newiceConnectionState=peer.iceConnectionState||"new",peer.oniceconnectionstatechange=function(){var state=peer.iceConnectionState,checkState=updatedStateList[state];peer.iceConnectionFiredStates&&"disconnected"!==checkState&&"failed"!==checkState&&"closed"!==checkState||(peer.iceConnectionFiredStates=[]);var newState=updatedStateList[state];peer.iceConnectionFiredStates.indexOf(newState)<0&&(peer.iceConnectionFiredStates.push(newState),"connected"===newState&&(setTimeout(function(){peer.iceConnectionFiredStates.push("done"),peer.newiceConnectionState="completed",peer.oniceconnectionnewstatechange(peer)},1e3),("connected"===peer.iceConnectionState||"completed"===peer.iceConnectionState)&&("opera"!==window.webrtcDetectedBrowser||"chrome"!==window.webrtcDetectedBrowser)&&peer.hasStream&&0===peer.getRemoteStreams().length&&(peer.hasStream=!1,"function"==typeof peer.onremovestream&&peer.onremovestream(peer))),peer.newiceConnectionState=newState,peer.onnewiceconnectionstatechange(peer))}},addCandidate:function(peer,candidate,successDefer,failureDefer){if(peer.remoteDescription)peer.addIceCandidate(candidate,successDefer,failureDefer);else if(peer.bufferCandidates=peer.bufferCandidates||[],peer.bufferCandidates.push(candidate),peer.waitForBuffer&&("connected"!==peer.newiceConnectionState||"completed"!==peer.newiceConnectionState))var waitForBuffer=setInterval(function(){if(peer.remoteDescription){clearInterval(waitForBuffer);var i;for(i=0;i<peer.bufferCandidates.length;i+=1)peer.addIceCandidate(peer.bufferCandidates[i],successDefer,failureDefer);delete peer.waitForBuffer}},10)},configureTURN:function(iceServers){var i,newConfig=[];for(i=0;i<iceServers.length;i+=1){var iceServer={url:iceServers[i].url};if(iceServers[i].credential&&(iceServer.credential=iceServers[i].credential),iceServers[i].username&&(iceServer.username=iceServers[i].username),"firefox"===window.webrtcDetectedBrowser&&0===iceServer.url.indexOf("turn")&&iceServer.url.indexOf("@")>0){var iceParts=iceServer.url.split(":"),subIceParts=iceParts[1].split("@");iceParts[1]=subIceParts[1],iceServer.url=iceParts.join(":"),iceServer.username=subIceParts[0]}newConfig.push(iceServer)}return newConfig}}},RoomEventMessageHandler={inRoom:function(com,data){com.self.routeMessage(data),com.iceServers=fn.isSafe(function(){return data.pc_config.iceServers})||[],com.respond("room:join",{user:com.self})},enter:function(com,data){var user=com.users[data.mid];if(fn.isEmpty(user)){var config={id:data.mid,stream:data.stream,agent:data.agent,bandwidth:data.bandwidth,data:data.userData,SDPType:"answer"};user=new User(config,com.routeEvent),com.users[data.mid]=user,"function"==typeof com.onuserjoin&&com.onuserjoin(user)}},welcome:function(com,data){var user=com.users[data.mid];if(fn.isEmpty(user)){var config={id:data.mid,stream:data.stream,agent:data.agent,bandwidth:data.bandwidth,data:data.userData,SDPType:"offer"};user=new User(config,com.routeEvent),com.users[data.mid]=user,"function"==typeof com.onuserjoin&&com.onuserjoin(user)}},offer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data)},answer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data)},candidate:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data)},updateUserEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data.userData)},muteAudioEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data)},muteVideoEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.routeMessage(data)},roomLockEvent:function(com,data){com.locked=data.lock,com.locked?"function"==typeof com.onlock&&com.onlock(data.mid):"function"==typeof com.onunlock&&com.onunlock(data.mid)},restart:function(com,data){var user=com.users[data.mid];if(fn.isEmpty(user))throw new Error('User "'+data.mid+'" does not exists');user.respondMessage(data)},redirect:function(com,data){"reject"===data.action&&com.respond("room:kick",{}),"warning"===data.action&&com.respond("room:warn",{})},bye:function(com,data){var user=com.users[data.mid];if(fn.isEmpty(user))throw new Error('User "'+data.mid+'" does not exists');user.disconnect()}},RoomEventReceivedHandler={socket:{connect:function(com){var message={type:"joinRoom",uid:com.self.username,cid:com.key,rid:com.id,userCred:com.self.token,timeStamp:com.self.timeStamp,apiOwner:com.owner,roomCred:com.token,start:com.startDateTime,len:com.duration};com.socket.send(message)},disconnect:function(com){com.respond("room:leave",{})},message:function(com,data,listener){"remote"===data.sourceType&&listener("message:"+com.data,data)},error:function(com,data){com.respond("room:error",{error:data,state:-2})}},user:{ready:function(com,data){var user=com.users[data.id],stream=com.self.streamConnections.main;fn.isEmpty(stream)||(data.streamObject=stream),data.iceServers=com.iceServers,user.routeMessage(data)}},self:{update:function(com,data){var message={type:"updateUserEvent",mid:data.id,rid:com.id,userData:data.userData};com.socket.send(message)},connect:function(com){var message=com.self.getInfo("main");message.type="enter",message.mid=com.self.id,message.rid=com.id,message.prid="main",com.socket.send(message)}},peer:{connect:function(com,data){var user=com.users[data.userId];if(fn.isEmpty(user))throw new Error('User "'+data.userId+'" does not exists');user.getInfo(data.id);if("answer"===data.SDPType){var message={type:"welcome",mid:com.self.id,rid:com.id,prid:data.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType,userInfo:com.self.getInfo(data.id),target:data.userId,weight:data.weight};com.socket.send(message)}},offer:function(com,data){var message={type:"offer",sdp:data.offer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id};com.socket.send(message)},answer:function(com,data){var message={type:"answer",sdp:data.answer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id};com.socket.send(message)},icecandidate:function(com,data){if("local"===data.sourceType){var message={type:"candidate",label:data.candidate.sdpMLineIndex,id:data.candidate.sdpMid,candidate:data.candidate.candidate,mid:com.self.id,prid:data.id,target:data.userId,rid:com.id};com.socket.send(message)}}}},RoomEventResponseHandler={init:function(com){"function"==typeof com.oninit&&com.oninit()},ready:function(com){"function"==typeof com.onready&&com.onready()},error:function(com,data){com.respond("room:error",{error:data.error,state:data.state}),"function"==typeof com.onerror&&com.onerror(data)},join:function(com){"function"==typeof com.onjoin&&com.onjoin(com.self)},leave:function(com){"function"==typeof com.onleave&&com.onleave()},kick:function(com,data){"function"==typeof com.onkick&&(com.onkick({message:data.info,reason:data.reason}),com.leave())},warn:function(com,data){"function"==typeof com.onwarn&&com.onwarn({message:data.info,reason:data.reason})}},RoomHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?(fn.applyHandler(RoomEventMessageHandler,params,[com,data,listener]),log.debug("Room","Received message event =>",event,data)):(0===event.indexOf("room:")?(data.name=com.name,fn.applyHandler(RoomEventResponseHandler,params,[com,data,listener]),log.debug("Room","Responding with event =>",event,data)):(data.roomName=com.name,fn.applyHandler(RoomEventReceivedHandler,params,[com,data,listener]),log.debug("Room","Received sub-class event =>",event,data)),listener(event,data))},SelfEventReceivedHandler={stream:{stop:function(com,data){com.findStreamConnectionId(data.id);com.respond("self:removestreamconnection",{streamId:data.id,peerId:key})}}},SelfEventResponseHandler={ready:function(com){"function"==typeof com.onready&&com.onready()},update:function(com,data){"function"==typeof com.onupdate&&com.onupdate(data)},addstreamconnection:function(com,data){"function"==typeof com.onaddstreamconnection&&com.onaddstreamconnection(data)},removestreamconnection:function(com,data){delete com.streamConnections[data.peerId],"function"==typeof com.onremovestreamconnection&&com.onremovestreamconnection(data)},connect:function(com){"function"==typeof com.onconnect&&com.onconnect()},disconnect:function(com,data){"function"==typeof com.ondisconnect&&com.ondisconnect(data)}},SelfHandler=function(com,event,data,listener){var params=event.split(":");data=data||{},0===event.indexOf("message:")?fn.applyHandler(SelfEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("self:")?(data.id=com.id,fn.applyHandler(SelfEventResponseHandler,params,[com,data,listener])):(data.selfId=com.selfId,fn.applyHandler(SelfEventReceivedHandler,params,[com,data,listener])),listener(event,data))},SocketEventResponseHandler={ready:function(com,data){"function"==typeof com.onstart&&com.onstart(data)},error:function(com,data){"function"==typeof com.onerror&&com.onerror(data)},connect:function(com,data){"function"==typeof com.onconnect&&com.onconnect(data)},connecterror:function(com,data){"function"==typeof com.onconnecterror&&com.onconnecterror(data)},reconnect:function(com,data){"function"==typeof com.onreconnect&&com.onreconnect(data)},message:function(){},disconnect:function(com,data){"function"==typeof com.ondisconnect&&com.ondisconnect(data)}},StreamHandler=function(com,event,data,listener){var params=event.split(":");data.server=com.server,data.port=com.port,data.type=com.type,data.protocol=com.protocol,fn.applyHandler(StreamEventResponseHandler,params,[com,data,listener]),listener(event,data),log.debug("Stream","Responding with event =>",event,data)},StreamEventResponseHandler={start:function(com,data){"function"==typeof com.onstart&&com.onstart(data.MediaStream)},error:function(com,data){"function"==typeof com.onerror&&com.onerror(data)},stop:function(com,data){"function"==typeof com.onstop&&com.onstop(data)},track:{start:function(com,data){"function"==typeof com.ontrackstart&&com.ontrackstart(data)},stop:function(com,data){"function"==typeof com.ontrackstop&&com.ontrackstop(data)},mute:function(com,data){"function"==typeof com.ontrackmute&&com.ontrackmute(data)},unmute:function(com,data){"function"==typeof com.ontrackunmute&&com.ontrackunmute(data)}}},StreamHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,data.label=com.label,fn.applyHandler(StreamEventResponseHandler,params,[com,data,listener]),listener(event,data),log.debug("Stream","Responding with event",event,data)},StreamParser={defaultConfig:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50},bandwidth:{audio:50,video:256,data:1638400}},parseAudioConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{}:options,tempOptions.stereo=!!options.stereo,tempOptions.sourceId=options.sourceId||null,tempOptions.mute="boolean"==typeof options.mute?options.mute:!1,options=tempOptions),userMedia="object"==typeof options?!0:options,tempOptions.sourceId&&tempOptions.audio!==!1&&(userMedia={optional:[{sourceId:tempOptions.sourceId}]}),{settings:options,userMedia:userMedia}},parseVideoConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{resolution:{}}:options,options.resolution=options.resolution||{},tempOptions.resolution=tempOptions.resolution||{},tempOptions.resolution.width=options.resolution.width||this.defaultConfig.video.resolution.width,tempOptions.resolution.height=options.resolution.height||this.defaultConfig.video.resolution.height,tempOptions.frameRate=options.frameRate||this.defaultConfig.video.frameRate,tempOptions.sourceId=options.sourceId||null,tempOptions.mute="boolean"==typeof options.mute?options.mute:!1,options=tempOptions,userMedia={mandatory:{maxWidth:tempOptions.resolution.width,maxHeight:tempOptions.resolution.height,maxFrameRate:tempOptions.frameRate},optional:[]},tempOptions.sourceId&&(userMedia.optional[0]={sourceId:tempOptions.sourceId}),"plugin"===window.webrtcDetectedType&&delete userMedia.mandatory.maxFrameRate),{settings:options,userMedia:userMedia}},parseBandwidthConfig:function(options){return options="object"==typeof options?options:{},options.audio="number"==typeof options.audio?options.audio:this.defaultConfig.bandwidth.audio,options.video="number"==typeof options.video?options.video:this.defaultConfig.bandwidth.video,options.data="number"==typeof options.data?options.data:this.defaultConfig.bandwidth.data,options},parseDefaultConfig:function(options){options=options||{},log.debug("Parsing stream settings. Default stream options:",options),options.maxWidth="number"==typeof options.maxWidth?options.maxWidth:640,options.maxHeight="number"==typeof options.maxHeight?options.maxHeight:480,this.defaultConfig.video.resolution.width=options.maxWidth,this.defaultConfig.video.resolution.height=options.maxHeight,log.debug("Parsed default media stream settings",this.defaultConfig)}},StreamPolyfill={stop:function(bind){if("webkit"!==window.webrtcDetectedType){var i,j,audioTracks=bind.getAudioTracks(),videoTracks=bind.getVideoTracks(),track=null,fn=function(){};for(i=0;i<audioTracks.length;i+=1)track=audioTracks[i],"firefox"===window.webrtcDetectedBrowser?this.track.stop(track):(fn=this.track.getFn(track,bind.id,"onended"))(track);for(j=0;j<videoTracks.length;j+=1)track=videoTracks[j],"firefox"===window.webrtcDetectedBrowser?this.track.stop(track):(fn=this.track.getFn(track,bind.id,"onended"))(track)}("firefox"===window.webrtcDetectedBrowser?bind instanceof LocalMediaStream:!0)&&bind.stop(),("safari"===window.webrtcDetectedType||"IE"===window.webrtcDetectedBrowser)&&delete this.track.fns[bind.id],"firefox"===window.webrtcDetectedBrowser&&(bind.ended=!0)},checkEnded:function(bind){if("firefox"===window.webrtcDetectedBrowser)if(bind.checkTracksEnded=setInterval(function(){var i,audios=bind.getAudioTracks(),videos=bind.getVideoTracks(),audioEnded=!0,videoEnded=!0;for(i=0;i<audios.length;i+=1)if(audios[i].ended!==!0){audioEnded=!1;break}for(i=0;i<videos.length;i+=1)if(videos[i].ended!==!0){videoEnded=!1;break}audioEnded&&videoEnded&&(clearInterval(bind.checkTracksEnded),bind.ended=!0)},1e3),bind.constructor===LocalMediaStream)bind.checkEnded=setInterval(function(){bind.ended&&(clearInterval(bind.checkEnded),"function"==typeof bind.onended&&bind.onended(bind)),"undefined"==typeof bind.recordedTime&&(bind.recordedTime=0),bind.recordedTime===bind.currentTime?(clearInterval(bind.checkEnded),bind.ended=!0,"function"==typeof bind.onended&&bind.onended(bind)):bind.recordedTime=bind.currentTime},1e3);else{var video=document.createElement("video");video.checkEnded=setInterval(function(){bind.ended&&(clearInterval(bind.checkEnded),"function"==typeof bind.onended&&bind.onended(bind)),"object"==typeof video.mozSrcObject&&null!==video.mozSrcObject&&video.mozSrcObject.ended===!0&&(clearInterval(bind.checkEnded),bind.ended=!0,"function"==typeof bind.onended&&bind.onended(bind))},1e3),bind.checkingVideo=video,window.attachMediaStream(video,bind)}},attachMediaStream:function(element,bind){"firefox"===window.webrtcDetectedBrowser&&"undefined"!=typeof bind.checkingVideo&&bind instanceof LocalMediaStream==!1?window.reattachMediaStream(element,bind.checkingVideo):window.attachMediaStream(element,bind)},track:{fns:{},getFn:function(bindTrack,mediaStreamId,fnName,fn){return this.fns[mediaStreamId]=this.fns[mediaStreamId]||{audio:{},video:{}},this.fns[mediaStreamId][bindTrack.kind]=this.fns[mediaStreamId][bindTrack.kind]||{},this.fns[mediaStreamId][bindTrack.kind][bindTrack.id]=this.fns[mediaStreamId][bindTrack.kind][bindTrack.id]||{},"function"!=typeof fn?this.fns[mediaStreamId][bindTrack.kind][bindTrack.id][fnName]||function(){}:void(this.fns[mediaStreamId][bindTrack.kind][bindTrack.id][fnName]=fn||function(){})},stop:function(bind){return"safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser?void log.warn("StreamPolyfill",window.webrtcDetectedBrowser.toUpperCase()+" (plugin-enabled) browser does not support MediaStreamTrack.stop() due to issues with the feature"):(bind.stop(),void("firefox"===window.webrtcDetectedBrowser&&bind.ended!==!0&&(bind.ended=!0,"function"==typeof bind.onended&&bind.onended(bind))))},checkEnded:function(bind,mediaStreamId){("safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser)&&this.getFn(bind,mediaStreamId,"onended",bind.onended)},checkMute:function(bind,mediaStreamId){("safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser)&&this.getFn(bind,mediaStreamId,"onmute",bind.onmute)},checkUnmute:function(bind,mediaStreamId){("safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser)&&this.getFn(bind,mediaStreamId,"onunmute",bind.onunmute)},mute:function(bind,mediaStreamId){if(bind.enabled=!1,bind.muted=!0,"safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser){var fn=this.getFn(bind,mediaStreamId,"onmute");fn(bind)}else"function"==typeof bind.onmute&&bind.onmute(bind)},unmute:function(bind,mediaStreamId){if(bind.enabled=!0,bind.muted=!1,"safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser){var fn=this.getFn(bind,mediaStreamId,"onunmute");fn(bind)}else"function"==typeof bind.onunmute&&bind.onunmute(bind)}}},StreamGetSources=function(defer){if("firefox"!==window.webrtcDetectedBrowser){var audioList=[],videoList=[];MediaStreamTrack.getSources(function(trackList){var i;for(i=0;i<trackList.length;i+=1){var track=trackList[i],data={};data.label=track.label||track.kind+"_"+(i+1),data.kind=track.kind,data.id=track.id,data.facing=track.facing,"audio"===track.kind?audioList.push(data):videoList.push(data)}defer({audio:audioList,video:videoList})})}},UserEventMessageHandler={enter:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)&&com.addConnection({id:data.prid,iceServers:data.iceServers,bandwidth:com.bandwidth,stream:data.stream,SDPType:"answer"},data.streamObject)},welcome:function(com,data){var peer=com.peers[data.prid];if(fn.isEmpty(peer))com.addConnection({id:data.prid,iceServers:data.iceServers,bandwidth:com.bandwidth,stream:data.stream,SDPType:"offer"},data.streamObject);else{if(peer.weight<data.weight)return;peer.SDPType="offer",data.type="start"}},offer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:offer",data)},answer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:answer",data)},candidate:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:candidate",data)},restart:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:restart",data)},updateUserEvent:function(com,data){com.data=data.data,com.handler("user:update",{data:data.userData})},muteAudioEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteAudioEvent",data)},muteVideoEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteVideoEvent",data)}},UserEventReceivedHandler={peer:{connect:function(com,data){var peer=com.peers[data.id];"function"==typeof com.onaddconnection&&com.onaddconnection(peer),"offer"===peer.SDPType&&peer.createOffer()},iceconnectionstate:function(com,data){"main"===data.id&&"connected"===data.state&&com.handler("user:connect",{})},disconnect:function(com,data){var peer=com.peers[data.id];delete com.peers[data.id],"function"==typeof com.onremoveconnection&&com.onremoveconnection(peer),0===Object.keys(com.peers).length&&com.handler("user:disconnect",{})}},transfer:{complete:function(com,data){com.handler("user:data",data)},request:function(com,data){com.handler("user:datarequest",data)}}},UserEventResponseHandler={ready:function(com){"function"==typeof com.onready&&com.onready()},connect:function(com){"function"==typeof com.onconnect&&com.onconnect()},data:function(com){"function"==typeof com.ondata&&com.ondata()},datarequest:function(com){"function"==typeof com.ondatarequest&&com.ondatarequest()},update:function(com,data){"function"==typeof com.onupdate&&com.onupdate(data.data)},addconnection:function(com){"function"==typeof com.onaddconnection&&com.onaddconnection()},removeconnection:function(com,data){"function"==typeof com.onremoveconnection&&com.onremoveconnection(data.data)},message:function(com){"function"==typeof com.onmessage&&com.onmessage()},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()}},UserHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?(fn.applyHandler(UserEventMessageHandler,params,[com,data,listener]),log.debug("Stream","Received message event",event,data)):(0===event.indexOf("user:")?(data.id=com.id,fn.applyHandler(UserEventResponseHandler,params,[com,data,listener]),log.debug("Stream","Responding with event",event,data)):(data.userId=com.id,fn.applyHandler(UserEventReceivedHandler,params,[com,data,listener]),log.debug("Stream","Received sub-class event",event,data)),listener(event,data))};